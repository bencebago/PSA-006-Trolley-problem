---
title: "Supplementary Analysis"
output:
  rmarkdown::pdf_document:
    extra_dependencies: ["float"]
    fig_caption: yes        
header-includes: 
  \usepackage{float} \floatplacement{figure}{H} 
  \newcommand{\beginsupplement}{\setcounter{table}{0}  \renewcommand{\thetable}{S\arabic{table}} \setcounter{figure}{0} \renewcommand{\thefigure}{S\arabic{figure}}}
editor_options: 
  chunk_output_type: console
---

\beginsupplement
```{r setup, echo=FALSE,message=FALSE, warning=FALSE, paged.print=FALSE}
# Load packages
library(BayesFactor)
library(reshape2)
library(ggplot2)
library(kableExtra)
library(lmerTest)
library(tidyverse)
library(jsonlite)
library(lubridate)
library(vroom)
library(countrycode)
library(gt)
library(janitor)
library(here)
library(ggrepel)

setwd("~/PSA-006-Trolley-problem")
trolley <- read_csv("data/trolley.csv",guess_max = 10000L)

```

```{r dem1,echo=FALSE,message=FALSE, warning=FALSE, paged.print=FALSE}

cd_raw <- read_csv(here::here("data/collectivism_similarity_matrix-from_culturaldistance.com.csv"))

cd <- 
  cd_raw %>% 
  transmute(country = names(.),
            Collectivism = `United States2010-2014`) %>% 
  extract(country, 
          into = c("Country", "distance_year"), 
          regex = "(.*)(\\d{4}-\\d{4})") %>% 
  # Get the latest similarity data
  group_by(Country) %>% 
  slice_tail(n = 1) %>% 
  ungroup() %>% 
  # USA should have 0 distance (not NA)
  mutate(Collectivism = if_else(is.na(Collectivism), 0, Collectivism),
         country3 = countryname(sourcevar = Country, 
                                destination = "iso3c")) 



```

```{r individualism score, echo=FALSE,message=FALSE, warning=FALSE, paged.print=FALSE}

trolley=merge(trolley,cd, by="country3", all=T)
trolley<-trolley[!is.na(trolley$survey_name),]


attach(trolley)
trolley$hor_ind=rowMeans(cbind(individualism_scale_1, individualism_scale_2,individualism_scale_3,individualism_scale_4))
trolley$ver_ind=rowMeans(cbind(individualism_scale_5, individualism_scale_6,individualism_scale_7,individualism_scale_8))
trolley$hor_col=rowMeans(cbind(individualism_scale_9, individualism_scale_10,individualism_scale_11,individualism_scale_12))
trolley$ver_col=rowMeans(cbind(individualism_scale_13, individualism_scale_14,individualism_scale_15,individualism_scale_16))
detach(trolley)

study1a <- filter(trolley, include_study1a)
study1b <- filter(trolley, include_study1b)
study2a <- filter(trolley, include_study2a)
study2b <- filter(trolley, include_study2b)

trolley_proc <- filter(trolley, include_allstudy_withoutfamiliarity)

trolley_familiar <- filter(trolley_proc, !include_nofamiliarity)



survey=levels(factor(trolley_proc$survey_name))




#cor.test(trolley_proc$hor_col, trolley_proc$familiarity)
#correlationBF(trolley_proc$hor_col, trolley_proc$familiarity)

```


#1. Demographics and exclusion 


```{r dem2,echo=FALSE,message=FALSE, warning=FALSE, paged.print=FALSE}
# Function to summarize studies into variables
summarise_study <- function(data = NULL){
  
  stopifnot(!is.null(data))
  
  data %>% 
    summarise(N = n(),
            `Age Mean` = mean(Age, na.rm = TRUE),
            `Age SD` = sd(Age, na.rm = TRUE),
            `Male %` = mean(Gender == 1, na.rm = TRUE),
            `Higher education %` = mean(`Higher education`, na.rm = TRUE),
            .groups = "drop")
  
}

summaries <-
  trolley %>% 
  nest(data = everything()) %>% 
  mutate(country_sum = map(data, 
                             ~group_by(.x, Region, country3) %>% 
                             summarise_study() %>% 
                             left_join(cd, by = "country3") %>% 
                             add_column(grouping = "By country", .before = 1) %>% 
                             mutate(Country = countrycode(sourcevar = country3, 
                                                          origin = "iso3c",
                                                          destination = "country.name")) %>% 
                             arrange(Region, Country)),
         region_sum = map(data, ~group_by(.x, Region) %>% 
                            summarise_study() %>% 
                            add_column(grouping = "By region", .before = 1) %>% 
                            arrange(Region)),
         all_sum =map(data, ~summarise_study(.x) %>% 
                        add_column(grouping = "All", .before = 1) %>% 
                        mutate(Region = "All")),
         # Add the 3 level summaries into one dateset
         bind_sum = pmap(list(country_sum, region_sum, all_sum), bind_rows))

demo_table <-
  summaries %>% 
  select(bind_sum) %>% 
  unnest(bind_sum) %>% 
  relocate(Country, .before = country3) %>% 
  select(-country3, -distance_year) %>% 
  gt(groupname_col = "grouping", 
     rowname_col = "Region") %>%
  fmt_number(columns = vars(`Age Mean`, `Age SD`),
             decimals = 1) %>% 
  cols_merge(columns = vars(`Age Mean`, `Age SD`), 
             pattern = "{1} ({2})") %>% 
  fmt_number(columns = vars(Collectivism),
             decimals = 3) %>% 
  fmt_percent(columns = vars(`Male %`, `Higher education %`),
              decimals = 1) %>% 
  fmt_missing(vars(Country, Collectivism, 
                   Region, grouping, `Higher education %`, 
                   `Male %`, `Age SD`)) %>% 
  cols_label(`Age Mean` = "Age (SD)") %>% 
  tab_footnote(footnote = "Distance from the US in collectivism. Some countries do not have a collectivism score.",
               locations = cells_column_labels(columns = vars(Collectivism))) %>% 
  tab_options(row.striping.include_table_body = TRUE,
              row.striping.background_color = "#EEEEEE", 
              row.striping.include_stub = TRUE,
              row_group.background.color = "#999999", 
              column_labels.background.color = "#999999")

demo_table

```


#2. Additional analysis

##Familiar participants

As we registered, we conducted the analysis on familiar participants, the results can be found below.

```{r familiar analysis s1, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

#use data study1a
tabledata_s1a = data.frame(Dilemma=c(rep("Trolley",3)),Cluster=c("Eastern", "Southern", "Western"), matrix(nrow=3, ncol=4, dimnames=list(survey,c("BF", "t", "df", "p"))))

for (i in survey){
dat=subset(trolley_familiar, survey_name==i, select=c("trolley_1_rate", "trolley_2_rate"))
dat_long=na.omit(melt(data=dat, variable.name = "condition", value.name="rate"))
datt=as_tibble(ttestBF(formula = rate ~ condition, data=dat_long, rscale=0.26, nullInterval = c(0, Inf)))
tabledata_s1a[i, "BF"]=signif(round(as.numeric(datt[2,1]),1),2)
frequentist=t.test(rate ~ condition, data=dat_long)
tabledata_s1a[i, "t"]=round(frequentist$statistic,2)
tabledata_s1a[i, "df"]=round(frequentist$parameter,2)
tabledata_s1a[i, "p"]=round(frequentist$p.value,4)
tabledata_s1a[i, "Cohen d"]=round(effsize::cohen.d(rate ~ condition, data=dat_long)[[3]] ,2)

}

tabledata_s1b = data.frame( Dilemma=c(rep("Speedboat",3)),Cluster=c("Eastern", "Southern", "Western"), matrix(nrow=3, ncol=4, dimnames=list(survey,c("BF", "t", "df", "p"))))

for (i in survey){
dat=subset(trolley_familiar, survey_name==i, select=c("speedboat_1_rate", "speedboat_2_rate"))
dat_long=na.omit(melt(data=dat, variable.name = "condition", value.name="rate"))
datt=as_tibble(ttestBF(formula = rate ~ condition, data=dat_long, rscale=0.26, nullInterval = c(0, Inf)))
tabledata_s1b[i, "BF"]=signif(round(as.numeric(datt[2,1]),1),2)
frequentist=t.test(rate ~ condition, data=dat_long)
tabledata_s1b[i, "t"]=round(frequentist$statistic,2)
tabledata_s1b[i, "df"]=round(frequentist$parameter,2)
tabledata_s1b[i, "p"]=round(frequentist$p.value,3)
tabledata_s1b[i, "Cohen d"]=round(effsize::cohen.d(rate ~ condition, data=dat_long)[[3]] ,2)

}


familiar_results = rbind(tabledata_s1a, tabledata_s1b)
rownames(familiar_results) <- NULL


kbl(
  familiar_results,
  format = "latex",
  booktabs = T,
  escape=T,
  caption = "The effect of personal force on participants familiar with the trolley problem.",
  centering=T,
  position="H"
  )%>%
  kable_styling( full_width = F,  position="left")%>%
  row_spec(row=0, bold=TRUE)%>%
  collapse_rows(columns = 1, valign = "top", latex_hline = "major", row_group_label_position = "identity")

```


```{r familiar analysis s2, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

#use data study1a

tabledata_s2a = data.frame(Dilemma=c(rep("Trolley",3)),Cluster=c("Eastern", "Southern", "Western"), matrix(nrow=3, ncol=4, dimnames=list(survey,c("BF", "F", "df", "p"))))

for (i in survey){
dat=subset(trolley_familiar, survey_name==i, select=c("trolley_3_rate", "trolley_4_rate", "trolley_5_rate", "trolley_6_rate"))
dat_long=na.omit(melt(data=dat, variable.name = "condition", value.name="rate"))
dat_long$personal_force = factor(ifelse(dat_long$condition=="trolley_3_rate"|dat_long$condition=="trolley_5_rate", 0, 1))
dat_long$intention = factor(ifelse(dat_long$condition=="trolley_4_rate"|dat_long$condition=="trolley_5_rate", 1, 0))
datt=lmBF(rate ~ personal_force*intention, data=dat_long, rscaleFixed=c("personal_force:intention"=0.19))
datt2=lmBF(rate ~ personal_force+intention, data=dat_long)
datt3=datt/datt2
datt3=as_tibble(recompute(datt3, iterations = 50000))
tabledata_s2a[i, "BF"]=signif(round(datt3[1,1],1),2)
frequentist=summary(aov(rate ~ personal_force*intention, data=dat_long))[[1]]
tabledata_s2a[i, "F"]=round(frequentist[3, "F value"],3)
tabledata_s2a[i, "df"]=paste("1, ", frequentist[4, "Df"])
tabledata_s2a[i, "p"]=round(frequentist[3, "Pr(>F)"],3)
tabledata_s2a[i, "Eta squared"]=round(DescTools::EtaSq(aov(rate ~ personal_force*intention, data=dat_long))[3,2],3)
tabledata_s2a[i, "Raw effect"]=(mean(dat_long[dat_long$personal_force==0 & dat_long$intention==0,]$rate,na.rm=T) - mean(dat_long[dat_long$personal_force==1 & dat_long$intention==0,]$rate,na.rm=T)) - (mean(dat_long[dat_long$personal_force==0 & dat_long$intention==1,]$rate,na.rm=T) - mean(dat_long[dat_long$personal_force==1 & dat_long$intention==1,]$rate,na.rm=T)) 

}


tabledata_s2b = data.frame(Dilemma=c("Speedboat", "Speedboat", "Speedboat"),Cluster=c("Eastern", "Southern", "Western"), matrix(nrow=3, ncol=4, dimnames=list(survey,c("BF","F", "df", "p"))))
for (i in survey){
dat=subset(trolley_familiar, survey_name==i, select=c("speedboat_3_rate", "speedboat_4_rate", "speedboat_5_rate", "speedboat_6_rate"))
dat_long=na.omit(melt(data=dat, variable.name = "condition", value.name="rate"))
dat_long$personal_force = factor(ifelse(dat_long$condition=="speedboat_3_rate"|dat_long$condition=="speedboat_5_rate", 0, 1))
dat_long$intention = factor(ifelse(dat_long$condition=="speedboat_4_rate"|dat_long$condition=="speedboat_5_rate", 1, 0))
datt=lmBF(rate ~ personal_force*intention, data=dat_long, rscaleFixed=c("personal_force:intention"=0.19))
datt2=lmBF(rate ~ personal_force+intention, data=dat_long)
datt3=datt/datt2
datt3=as_tibble(recompute(datt3, iterations = 50000))
tabledata_s2b[i, "BF"]=signif(round(datt3[1,1],1),2)
frequentist=summary(aov(rate ~ personal_force*intention, data=dat_long))[[1]]
tabledata_s2b[i, "F"]=round(frequentist[3, "F value"],3)
tabledata_s2b[i, "df"]=paste("1, ", frequentist[4, "Df"])
tabledata_s2b[i, "p"]=round(frequentist[3, "Pr(>F)"],3)
tabledata_s2b[i, "Eta squared"]=round(DescTools::EtaSq(aov(rate ~ personal_force*intention, data=dat_long))[3,2],3)
tabledata_s2b[i, "Raw effect"]=(mean(dat_long[dat_long$personal_force==0 & dat_long$intention==0,]$rate,na.rm=T) - mean(dat_long[dat_long$personal_force==1 & dat_long$intention==0,]$rate,na.rm=T)) - (mean(dat_long[dat_long$personal_force==0 & dat_long$intention==1,]$rate,na.rm=T) - mean(dat_long[dat_long$personal_force==1 & dat_long$intention==1,]$rate,na.rm=T)) 

}

familiar_results = rbind(tabledata_s2a, tabledata_s2b)
rownames(familiar_results) <- NULL


kbl(
  familiar_results,
  format = "latex",
  booktabs = T,
  escape=T,
  caption = "The interaction effect of personal force and intention on familiar participants.",
  centering=T,
  position="H"
  )%>%
  kable_styling( full_width = F,  position="left")%>%
  row_spec(row=0, bold=TRUE)%>%
  collapse_rows(columns = 1, valign = "top", latex_hline = "major", row_group_label_position = "identity")

```


##Effect of physical contact and intention

In every cluster and for both types of dilemma we found good enough evidence supporting the alternative hypothesis when testing the effect of physical contact and the effect of intention. The summary of the results can be found in the tables below.

```{r physical contact , echo = FALSE, message = FALSE, warning = FALSE, paged.print = FALSE}
# Tidy Bf extractor function
my_bf_extractor <- function(bf_obj) {
  BayesFactor::extractBF(bf_obj) %>% 
    tibble::rownames_to_column(var = "scale") %>% 
    dplyr::mutate(scale = stringr::str_extract(scale, "(?<=\\s)(.*)(?=\\s)"))
}

# Comparing standard footbridge with footbridge pole in every cluster
additional_res_1 <- 
  trolley_proc %>% 
  select(survey_name, survey_id, matches("trolley_[0-9]_rate|speedboat_[0-9]_rate")) %>% 
  pivot_longer(matches("_rate"), names_to = "task", names_pattern = "(.*)_rate", values_to = "rate") %>% 
  mutate(comparison = case_when(task %in% c("trolley_1", "trolley_4") ~ "trolley_physical",
                                task %in% c("speedboat_1", "speedboat_4") ~ "speedboat_physical",
                                task %in% c("trolley_3", "trolley_2") ~ "trolley_intention",
                                task %in% c("speedboat_3", "speedboat_2") ~ "speedboat_intention",
                                TRUE ~ NA_character_)) %>% 
  drop_na(rate, comparison) %>% 
  nest(data = c(survey_id, task, rate)) %>% 
  mutate(bf_res = map(data, ~ ttestBF(formula = rate ~ task, data = .x, rscale=0.26)),
         bf = map_dbl(bf_res, ~ round(my_bf_extractor(.x)$bf, 2)),
         freq_res = map(data, ~ t.test(rate ~ task, data = .x,  paired = FALSE) %>% broom::tidy()),
         t = map_dbl(freq_res, ~ round(.x$statistic, 2)),
         p = map_dbl(freq_res, ~ round(.x$p.value, 2)),
         df = map_dbl(freq_res, ~ round(.x$parameter, 2)))

additional_res_1 %>% 
  filter(str_detect(comparison, "intention|physical")) %>% 
  separate(comparison, into = c("Dilemma", "Comparison"), sep = "_") %>% 
  transmute(Cluster = str_remove(survey_name, "^[^_]*_"),
            Dilemma = str_to_title(Dilemma),
            Comparison = case_when(Comparison == "physical" ~ "Physical Contact",
                                   Comparison == "intention" ~ "Intention"),
            t,
            `Bf` = scales::scientific(bf),
            df,
            p = as.character(p),
            p = if_else(as.numeric(p) < .001, "< .001", p)) %>% 
  papaja::apa_table(
    caption = "Effect of Physical Contact and Intention",
    escape = TRUE)
```

```{r, echo = FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
# Additional analysis after all exclusions
additional_res_1_excluded <- 
  trolley %>%
  filter(include_study1a | include_study1b | include_study2a | include_study2b) %>% 
  select(survey_name, survey_id, matches("trolley_[0-9]_rate|speedboat_[0-9]_rate")) %>% 
  pivot_longer(matches("_rate"), names_to = "task", names_pattern = "(.*)_rate", values_to = "rate") %>% 
  mutate(comparison = case_when(task %in% c("trolley_1", "trolley_4") ~ "trolley_physical",
                                task %in% c("speedboat_1", "speedboat_4") ~ "speedboat_physical",
                                task %in% c("trolley_3", "trolley_2") ~ "trolley_intention",
                                task %in% c("speedboat_3", "speedboat_2") ~ "speedboat_intention",
                                TRUE ~ NA_character_)) %>% 
  drop_na(rate, comparison) %>% 
  nest(data = c(survey_id, task, rate)) %>% 
  mutate(bf_res = map(data, ~ ttestBF(formula = rate ~ task, data = .x, rscale=0.26)),
         bf = map_dbl(bf_res, ~ round(my_bf_extractor(.x)$bf, 2)),
         freq_res = map(data, ~ t.test(rate ~ task, data = .x,  paired = FALSE) %>% broom::tidy()),
         t = map_dbl(freq_res, ~ round(.x$statistic, 2)),
         p = map_dbl(freq_res, ~ round(.x$p.value, 2)),
         df = map_dbl(freq_res, ~ round(.x$parameter, 2)))

additional_res_1_excluded %>% 
  filter(str_detect(comparison, "intention|physical")) %>% 
  separate(comparison, into = c("Dilemma", "Comparison"), sep = "_") %>% 
  transmute(Cluster = str_remove(survey_name, "^[^_]*_"),
            Dilemma = str_to_title(Dilemma),
            Comparison = case_when(Comparison == "physical" ~ "Physical Contact",
                                   Comparison == "intention" ~ "Intention"),
            t,
            `Bf` = scales::scientific(bf),
            df,
            p = as.character(p),
            p = if_else(as.numeric(p) < .001, "< .001", p)) %>% 
  papaja::apa_table(
    caption = "Effect of Physical Contact and Intention",
    escape = TRUE)
```

##Comparing the standard switch and standard footbridge dilemmas

When comparing the standard switch and standard footbridge dilemmas in all clusters for the trolley and the speedboat tasks we found good enough evidence in every case for the support of the alternative hypothesis. The summary results of each comparison separately can be found in Tables below.

```{r, standard switch and footbridge, echo = FALSE, message = FALSE, warning = FALSE, paged.print = FALSE}
additional_res_2 <- 
  trolley_proc %>% 
  select(survey_name, survey_id, matches("trolley_[0-9]_rate|speedboat_[0-9]_rate")) %>% 
  pivot_longer(matches("_rate"), names_to = "task", names_pattern = "(.*)_rate", values_to = "rate") %>% 
  mutate(comparison = case_when(task %in% c("trolley_3", "trolley_4") ~ "trolley_standard",
                                task %in% c("speedboat_3", "speedboat_4") ~ "speedboat_standard",
                                TRUE ~ NA_character_)) %>% 
  drop_na(rate, comparison) %>% 
  nest(data = c(survey_id, task, rate)) %>% 
  mutate(bf_res = map(data, ~ ttestBF(formula = rate ~ task, data = .x, rscale=0.26)),
         bf = map_dbl(bf_res, ~ round(my_bf_extractor(.x)$bf, 2)),
         freq_res = map(data, ~ t.test(rate ~ task, data = .x,  paired = FALSE) %>% broom::tidy()),
         t = map_dbl(freq_res, ~ round(.x$statistic, 2)),
         p = map_dbl(freq_res, ~ round(.x$p.value, 2)),
         df = map_dbl(freq_res, ~ round(.x$parameter, 2)))

additional_res_2 %>% 
  filter(str_detect(comparison, "standard")) %>% 
  separate(comparison, into = c("Dilemma", "Comparison"), sep = "_") %>% 
  transmute(Cluster = str_remove(survey_name, "^[^_]*_"),
            Dilemma = str_to_title(Dilemma),
            t,
            `Bf` = scales::scientific(bf),
            df,
            p = as.character(p),
            p = if_else(as.numeric(p) < .001, "< .001", p)) %>% 
  papaja::apa_table(
    caption = "Comparing the Standard Switch and Standard Footbridge Dilemmas",
    escape = TRUE)
```

```{r, echo = FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
#Additional analysis after all exclusions
additional_res_2_excluded <- 
  trolley %>%
  filter(include_study1a | include_study1b | include_study2a | include_study2b) %>% 
  select(survey_name, survey_id, matches("trolley_[0-9]_rate|speedboat_[0-9]_rate")) %>% 
  pivot_longer(matches("_rate"), names_to = "task", names_pattern = "(.*)_rate", values_to = "rate") %>% 
  mutate(comparison = case_when(task %in% c("trolley_3", "trolley_4") ~ "trolley_standard",
                                task %in% c("speedboat_3", "speedboat_4") ~ "speedboat_standard",
                                TRUE ~ NA_character_)) %>% 
  drop_na(rate, comparison) %>% 
  nest(data = c(survey_id, task, rate)) %>% 
  mutate(bf_res = map(data, ~ ttestBF(formula = rate ~ task, data = .x, rscale=0.26)),
         bf = map_dbl(bf_res, ~ round(my_bf_extractor(.x)$bf, 2)),
         freq_res = map(data, ~ t.test(rate ~ task, data = .x,  paired = FALSE) %>% broom::tidy()),
         t = map_dbl(freq_res, ~ round(.x$statistic, 2)),
         p = map_dbl(freq_res, ~ round(.x$p.value, 2)),
         df = map_dbl(freq_res, ~ round(.x$parameter, 2)))

additional_res_2_excluded %>% 
  filter(str_detect(comparison, "standard")) %>% 
  separate(comparison, into = c("Dilemma", "Comparison"), sep = "_") %>% 
  transmute(Cluster = str_remove(survey_name, "^[^_]*_"),
            Dilemma = str_to_title(Dilemma),
            t,
            `Bf` = scales::scientific(bf),
            df,
            p = as.character(p),
            p = if_else(as.numeric(p) < .001, "< .001", p)) %>% 
  papaja::apa_table(
    caption = "Comparing the Standard Switch and Standard Footbridge Dilemmas",
    escape = TRUE)
```

##Oxford utilitarianism Scale

As we registered, we simply publish descriptive statistics of the Oxford Utilitarianism Scale in each cultural clusters.

```{r, echo = FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
# Prepare data for plotting
plot_data <-
  trolley_proc %>% 
  select(survey_name, lab, ResponseId, contains("oxford_")) %>%
  pivot_longer(
    contains("oxford_"),
    names_to = "item_no",
    values_to = "rate",
    names_prefix = "oxford_utilitarian_") %>%
  mutate(item_no = as.integer(item_no),
         subscale = case_when(item_no == 1L ~ "Impartial Beneficence",
                              item_no == 2L ~ "Instrumental Harm",
                              item_no == 3L ~ "Impartial Beneficence",
                              item_no == 4L ~ "Instrumental Harm",
                              item_no == 5L ~ "Impartial Beneficence",
                              item_no == 6L ~ "Instrumental Harm",
                              item_no == 7L ~ "Impartial Beneficence",
                              item_no == 8L ~ "Instrumental Harm",
                              item_no == 9L ~ "Impartial Beneficence",
                              TRUE ~ NA_character_),
         survey_name = str_remove(survey_name, "PSA006_")) %>% 
  drop_na(rate)

# Create plot
plot_data %>% 
  ggplot() +
  aes(
    x = subscale,
    y = rate,
    width = 0.7) +
  geom_boxplot() +
  facet_wrap(facets = vars(survey_name)) +
  labs(
    y = "Rating",
    x = "Subscale") +
  scale_y_continuous(
    breaks = 1:7,
    labels = as.character(1:7)) + 
  theme_bw() +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.title = element_text(hjust = 0.5, vjust = 0.5, face = "bold", size = 17),
    axis.title.x = element_blank(),
    axis.title.y = element_text(face = "bold", size = 10),
    axis.text.x = element_text(face = "bold", size = 7, colour = "Black"),
    axis.text.y = element_text(face = "bold", size = 12, colour = "Black"),
    legend.title = element_blank(),
    legend.text = element_text(size = 9))
```


#Exploratory analysis on overall utilitarianism and collectivism

ALthough not part of the planned analysis, we hypothesized that country-level collectivism would be associated with utilitarian responding (i.e., higher morall acceptibility ratings). We found no evidence for this hypothesis, regardless of familiarity exclusion or dilemma context. Interestingly, however, we found strong evidence for the association between vertical individualism and average moral acceptibility ratings on moral dilemmas, regardless of dilemma context or exclusion criteria. The positive association means that higher levels of vertical individualism is associated with higher acceptance of the utilitarian response option. 

In all of the regression models below, we added the random intercept of countries.

##With all exclusions

<!-- Bayesian country level individualism w/o exclusion -->
```{r analysis individual + country level study 2a, echo =FALSE,message=FALSE, warning=FALSE, paged.print=FALSE}

utilitarian_trolley <- filter(trolley, include_study1a|include_study2a)
utilitarian_speedboat <- filter(trolley, include_study1b|include_study2b)



vars=c("Collectivism", "ver_ind", "hor_ind", "ver_col", "hor_col")
tabledata_s2a_ind = data.frame(variable=c("Country-level collectivism", "Vertical Individualism", "Horizontal Individualism", "Vertical Collectivism", "Horizontal Collectivism"), matrix(nrow=5, ncol=3, dimnames=list(vars,c("BF", "b",  "p"))))

dat=subset(utilitarian_trolley,  select=c("trolley_1_rate", "trolley_2_rate", "trolley_3_rate", "trolley_4_rate", "trolley_5_rate", "trolley_6_rate", "country3", vars))
dat_long=na.omit(melt(data=dat, variable.name = "condition", value.name="rate", id.vars=c(vars, "country3")))
dat_long$country3=as.character(dat_long$country3)
dat_long$country3=factor(paste0("0", dat_long$country3))

graphdata=data.frame(variable=c("Country-level collectivism", "Vertical Individualism", "Horizontal Individualism", "Vertical Collectivism", "Horizontal Collectivism"), matrix(nrow=5, ncol=3, dimnames=list(vars,c("b",  "lower", "higher"))))

for (i in vars){
  if(i=="Collectivism"){
  datt=lmBF(rate ~   Collectivism + country3, data=dat_long, whichRandom="country3",rscaleCont = c("Collectivism" = 0.19))
  datt2=lmBF(rate ~  country3, whichRandom="country3",data=dat_long)  
  frequentist_m=lmer(rate ~ Collectivism +(1|country3), data=dat_long)
  frequentist=broom.mixed::tidy(frequentist_m)
  } else if(i=="ver_ind"){
  datt=lmBF(rate ~   ver_ind + country3, data=dat_long, whichRandom="country3",rscaleCont = c("ver_ind" = 0.19))
  datt2=lmBF(rate ~  country3, whichRandom="country3",data=dat_long)  
  frequentist_m=lmer(rate ~ ver_ind +(1|country3), data=dat_long)
  frequentist=broom.mixed::tidy(frequentist_m)
  }else if(i=="hor_ind"){
  datt=lmBF(rate ~   hor_ind + country3, data=dat_long, whichRandom="country3",rscaleCont = c("hor_ind" = 0.19))
  datt2=lmBF(rate ~  country3, whichRandom="country3",data=dat_long)  
  frequentist_m=lmer(rate ~ hor_ind +(1|country3), data=dat_long)
  frequentist=broom.mixed::tidy(frequentist_m)
  }else if(i=="ver_col"){
  datt=lmBF(rate ~   ver_col + country3, data=dat_long, whichRandom="country3",rscaleCont = c("ver_col" = 0.19))
  datt2=lmBF(rate ~  country3, whichRandom="country3",data=dat_long)  
  frequentist_m=lmer(rate ~ ver_col +(1|country3), data=dat_long)
  frequentist=broom.mixed::tidy(frequentist_m)
  }else if(i=="hor_col"){
  datt=lmBF(rate ~   hor_col + country3, data=dat_long, whichRandom="country3",rscaleCont = c("hor_col" = 0.19))
  datt2=lmBF(rate ~  country3, whichRandom="country3",data=dat_long)  
  frequentist_m=lmer(rate ~ hor_col +(1|country3), data=dat_long)
  frequentist=broom.mixed::tidy(frequentist_m)
  }
datt3=datt/datt2
datt3=as_tibble(recompute(datt3, iterations = 50000))
tabledata_s2a_ind[i, "BF"]=signif(datt3[1,1],4)
tabledata_s2a_ind[i, "b"]=round(frequentist[2, "estimate"],3)
tabledata_s2a_ind[i, "p"]=round(frequentist[2, "p.value"],3)
graphdata[i, "b"]=round(frequentist[2, "estimate"],3)
graphdata[i, "lower"]=round(confint(frequentist_m),2)[4,1]
graphdata[i, "higher"]=round(confint(frequentist_m),2)[4,2]

}

graphdata=graphdata[-1,]
rownames(tabledata_s2a_ind) <- NULL


kbl(
  tabledata_s2a_ind,
  format = "latex",
  booktabs = T,
  escape=T,
  caption = "Is the interaction of personal force and intention affected by individualism/collectivism on Trolley dilemmas?",
  centering=T,
  position="H"
  )%>%
  kable_styling( full_width = F,  position="left")%>%
  row_spec(row=0, bold=TRUE)

```


```{r study2a overall individualism plot, fig.pos="H",out.width="80%",fig.cap="Correlation between country-level individualism/collectivism and moral accessibility ratings on the Trolley dilemmas (higher moral acceptibility means higher acceptibility of the utilitarian choice).", echo =FALSE,message=FALSE, warning=FALSE, paged.print=FALSE}
##cohen d calculation for every country
#scatterplot: x effect size, y individualism
#size of dots: cohen d
countrydata=data.frame(country=levels(factor(utilitarian_trolley$country3)), matrix(nrow=length(levels(factor(utilitarian_trolley$country3))),ncol=3, dimnames=list(levels(factor(utilitarian_trolley$country3)), c("cohend","Collectivism","N") )))

for (i in levels(factor(utilitarian_trolley$country3))){
  d=subset(utilitarian_trolley, country3==i, select=c("trolley_1_rate", "trolley_2_rate", "trolley_3_rate", "trolley_4_rate", "trolley_5_rate", "trolley_6_rate"))
  dat_long=na.omit(melt(data=d, variable.name = "condition", value.name="rate"))
  if (length(dat_long$rate)<10){
    countrydata[i,"cohend"]=NA
  }else{
    countrydata[i,"cohend"]=mean(dat_long$rate)
  }
  countrydata[i,"Collectivism"]=mean(utilitarian_trolley[utilitarian_trolley$country3==i,]$Collectivism, na.rm=T)
  countrydata[i,"N"]=length(dat_long$rate)
}

countrydata=na.omit(countrydata)
ggplot(countrydata, aes(x=cohend, y=Collectivism, label=country)) +
  geom_point(aes(size=N))+
  geom_text(hjust=-0.2,size=3)+
geom_smooth(method = "lm", mapping = aes(weight = N), color = "blue", show.legend = FALSE, se=F)+xlab("Average moral acceptibility rating")+
  theme_bw()+
  theme(panel.grid.major=element_blank(),panel.grid.minor=element_blank(),plot.title=element_text( hjust=0.5, vjust=0.5, face="bold", size=17),
        axis.title.x=element_text(face="bold", size=12, colour="Black"), axis.title.y=element_text(face="bold", size=12, colour="Black"), axis.text.x = element_text(face="bold", size=10, colour="Black"), axis.text.y = element_text(face="bold", size=12, colour="Black"),
        legend.title=element_text(face="bold", size=10, colour="Black"),legend.text=element_text(size=9))
  
  

```


<!-- Bayesian personal level individualism  w/o exclusion-->
```{r study2a vertical horizontal individualism, out.width="80%", fig.cap="Personal level individualism/collectivism effects on moral acceptibility ratings (trolley dilemmas)", echo =FALSE,message=FALSE, warning=FALSE, paged.print=FALSE}


ggplot(graphdata, aes(x=variable, y=b, width=0.7)) +
 geom_bar(stat="identity", position="dodge", colour="Black",  width=1.2)+
  geom_errorbar(aes(ymin=lower, ymax=higher), position=position_dodge(width=0.7), colour="Black", width=0.2) +
  labs( y="Beta effect size")+ theme_bw()+
  geom_hline(yintercept=0)+
  theme(panel.grid.major=element_blank(),panel.grid.minor=element_blank(),plot.title=element_text( hjust=0.5, vjust=0.5, face="bold", size=17),
        axis.title.x=element_blank(), axis.title.y=element_text(face="bold", size=10), axis.text.x = element_text(face="bold", size=7, colour="Black"), axis.text.y = element_text(face="bold", size=12, colour="Black"),
        legend.title=element_blank(),legend.text=element_text(size=9))


```


<!-- Bayesian country level individualism w/o exclusion -->
```{r analysis individual + country level study 2b, echo =FALSE,message=FALSE, warning=FALSE, paged.print=FALSE}

vars=c("Collectivism", "ver_ind", "hor_ind", "ver_col", "hor_col")
tabledata_s2b_ind = data.frame(variable=c("Country-level collectivism", "Vertical Individualism", "Horizontal Individualism", "Vertical Collectivism", "Horizontal Collectivism"), matrix(nrow=5, ncol=3, dimnames=list(vars,c("BF", "b",  "p"))))

dat=subset(utilitarian_speedboat,  select=c("speedboat_1_rate", "speedboat_2_rate", "speedboat_3_rate", "speedboat_4_rate", "speedboat_5_rate", "speedboat_6_rate", "country3", vars))
dat_long=na.omit(melt(data=dat, variable.name = "condition", value.name="rate", id.vars=c(vars, "country3")))
dat_long$country3=as.character(dat_long$country3)
dat_long$country3=factor(paste0("0", dat_long$country3))

graphdata=data.frame(variable=c("Country-level collectivism", "Vertical Individualism", "Horizontal Individualism", "Vertical Collectivism", "Horizontal Collectivism"), matrix(nrow=5, ncol=3, dimnames=list(vars,c("b",  "lower", "higher"))))

for (i in vars){
  if(i=="Collectivism"){
  datt=lmBF(rate ~   Collectivism + country3, data=dat_long, whichRandom="country3",rscaleCont = c("Collectivism" = 0.19))
  datt2=lmBF(rate ~  country3, whichRandom="country3",data=dat_long)  
  frequentist_m=lmer(rate ~ Collectivism +(1|country3), data=dat_long)
  frequentist=broom.mixed::tidy(frequentist_m)
  } else if(i=="ver_ind"){
  datt=lmBF(rate ~   ver_ind + country3, data=dat_long, whichRandom="country3",rscaleCont = c("ver_ind" = 0.19))
  datt2=lmBF(rate ~  country3, whichRandom="country3",data=dat_long)  
  frequentist_m=lmer(rate ~ ver_ind +(1|country3), data=dat_long)
  frequentist=broom.mixed::tidy(frequentist_m)
  }else if(i=="hor_ind"){
  datt=lmBF(rate ~   hor_ind + country3, data=dat_long, whichRandom="country3",rscaleCont = c("hor_ind" = 0.19))
  datt2=lmBF(rate ~  country3, whichRandom="country3",data=dat_long)  
  frequentist_m=lmer(rate ~ hor_ind +(1|country3), data=dat_long)
  frequentist=broom.mixed::tidy(frequentist_m)
  }else if(i=="ver_col"){
  datt=lmBF(rate ~   ver_col + country3, data=dat_long, whichRandom="country3",rscaleCont = c("ver_col" = 0.19))
  datt2=lmBF(rate ~  country3, whichRandom="country3",data=dat_long)  
  frequentist_m=lmer(rate ~ ver_col +(1|country3), data=dat_long)
  frequentist=broom.mixed::tidy(frequentist_m)
  }else if(i=="hor_col"){
  datt=lmBF(rate ~   hor_col + country3, data=dat_long, whichRandom="country3",rscaleCont = c("hor_col" = 0.19))
  datt2=lmBF(rate ~  country3, whichRandom="country3",data=dat_long)  
  frequentist_m=lmer(rate ~ hor_col +(1|country3), data=dat_long)
  frequentist=broom.mixed::tidy(frequentist_m)
  }
datt3=datt/datt2
datt3=as_tibble(recompute(datt3, iterations = 50000))
tabledata_s2b_ind[i, "BF"]=signif(datt3[1,1],4)
tabledata_s2b_ind[i, "b"]=round(frequentist[2, "estimate"],3)
tabledata_s2b_ind[i, "p"]=round(frequentist[2, "p.value"],3)
graphdata[i, "b"]=round(frequentist[2, "estimate"],3)
graphdata[i, "lower"]=round(confint(frequentist_m),2)[4,1]
graphdata[i, "higher"]=round(confint(frequentist_m),2)[4,2]

}

graphdata=graphdata[-1,]
rownames(tabledata_s2b_ind) <- NULL


kbl(
  tabledata_s2b_ind,
  format = "latex",
  booktabs = T,
  escape=T,
  caption = "Is the interaction of personal force and intention affected by individualism/collectivism on Trolley dilemmas?",
  centering=T,
  position="H"
  )%>%
  kable_styling( full_width = F,  position="left")%>%
  row_spec(row=0, bold=TRUE)

```


```{r study2b overall individualism plot, fig.pos="H",out.width="80%",fig.cap="Correlation between country-level individualism/collectivism and moral accessibility ratings on the Speedboat dilemmas (higher moral acceptibility means higher acceptibility of the utilitarian choice)", echo =FALSE,message=FALSE, warning=FALSE, paged.print=FALSE}
##cohen d calculation for every country
#scatterplot: x effect size, y individualism
#size of dots: cohen d
countrydata=data.frame(country=levels(factor(utilitarian_speedboat$country3)), matrix(nrow=length(levels(factor(utilitarian_speedboat$country3))),ncol=3, dimnames=list(levels(factor(utilitarian_speedboat$country3)), c("cohend","Collectivism","N") )))

for (i in levels(factor(utilitarian_speedboat$country3))){
  d=subset(utilitarian_speedboat, country3==i, select=c("speedboat_1_rate", "speedboat_2_rate", "speedboat_3_rate", "speedboat_4_rate", "speedboat_5_rate", "speedboat_6_rate"))
  dat_long=na.omit(melt(data=d, variable.name = "condition", value.name="rate"))
  if (length(dat_long$rate)<10){
    countrydata[i,"cohend"]=NA
  }else{
    countrydata[i,"cohend"]=mean(dat_long$rate)
  }
  countrydata[i,"Collectivism"]=mean(utilitarian_speedboat[utilitarian_speedboat$country3==i,]$Collectivism, na.rm=T)
  countrydata[i,"N"]=length(dat_long$rate)
}

countrydata=na.omit(countrydata)
ggplot(countrydata, aes(x=cohend, y=Collectivism, label=country)) +
  geom_point(aes(size=N))+
  geom_text(hjust=-0.2,size=3)+
geom_smooth(method = "lm", mapping = aes(weight = N), color = "blue", show.legend = FALSE, se=F)+xlab("Average moral acceptibility rating")+
  theme_bw()+
  theme(panel.grid.major=element_blank(),panel.grid.minor=element_blank(),plot.title=element_text( hjust=0.5, vjust=0.5, face="bold", size=17),
        axis.title.x=element_text(face="bold", size=12, colour="Black"), axis.title.y=element_text(face="bold", size=12, colour="Black"), axis.text.x = element_text(face="bold", size=10, colour="Black"), axis.text.y = element_text(face="bold", size=12, colour="Black"),
        legend.title=element_text(face="bold", size=10, colour="Black"),legend.text=element_text(size=9))
  
  

```


<!-- Bayesian personal level individualism  w/o exclusion-->
```{r study2b vertical horizontal individualism,  out.width="80%", fig.cap="Personal level individualism/collectivism effects on moral acceptibility ratings (speedboat dilemmas)", echo =FALSE,message=FALSE, warning=FALSE, paged.print=FALSE}


ggplot(graphdata, aes(x=variable, y=b, width=0.7)) +
 geom_bar(stat="identity", position="dodge", colour="Black",  width=1.2)+
  geom_errorbar(aes(ymin=lower, ymax=higher), position=position_dodge(width=0.7), colour="Black", width=0.2) +
  labs( y="Beta effect size")+ theme_bw()+
  geom_hline(yintercept=0)+
  theme(panel.grid.major=element_blank(),panel.grid.minor=element_blank(),plot.title=element_text( hjust=0.5, vjust=0.5, face="bold", size=17),
        axis.title.x=element_blank(), axis.title.y=element_text(face="bold", size=10), axis.text.x = element_text(face="bold", size=7, colour="Black"), axis.text.y = element_text(face="bold", size=12, colour="Black"),
        legend.title=element_blank(),legend.text=element_text(size=9))



```


##Without familiarity exclusion

<!-- Bayesian country level individualism w/o exclusion -->
```{r analysis individual + country level study 2a w/o excl, echo =FALSE,message=FALSE, warning=FALSE, paged.print=FALSE}

utilitarian_trolley <- filter(trolley_proc)
utilitarian_speedboat <- filter(trolley_proc)



vars=c("Collectivism", "ver_ind", "hor_ind", "ver_col", "hor_col")
tabledata_s2a_ind = data.frame(variable=c("Country-level collectivism", "Vertical Individualism", "Horizontal Individualism", "Vertical Collectivism", "Horizontal Collectivism"), matrix(nrow=5, ncol=3, dimnames=list(vars,c("BF", "b",  "p"))))

dat=subset(utilitarian_trolley,  select=c("trolley_1_rate", "trolley_2_rate", "trolley_3_rate", "trolley_4_rate", "trolley_5_rate", "trolley_6_rate", "country3", vars))
dat_long=na.omit(melt(data=dat, variable.name = "condition", value.name="rate", id.vars=c(vars, "country3")))
dat_long$country3=as.character(dat_long$country3)
dat_long$country3=factor(paste0("0", dat_long$country3))

graphdata=data.frame(variable=c("Country-level collectivism", "Vertical Individualism", "Horizontal Individualism", "Vertical Collectivism", "Horizontal Collectivism"), matrix(nrow=5, ncol=3, dimnames=list(vars,c("b",  "lower", "higher"))))

for (i in vars){
  if(i=="Collectivism"){
  datt=lmBF(rate ~   Collectivism + country3, data=dat_long, whichRandom="country3",rscaleCont = c("Collectivism" = 0.19))
  datt2=lmBF(rate ~  country3, whichRandom="country3",data=dat_long)  
  frequentist_m=lmer(rate ~ Collectivism +(1|country3), data=dat_long)
  frequentist=broom.mixed::tidy(frequentist_m)
  } else if(i=="ver_ind"){
  datt=lmBF(rate ~   ver_ind + country3, data=dat_long, whichRandom="country3",rscaleCont = c("ver_ind" = 0.19))
  datt2=lmBF(rate ~  country3, whichRandom="country3",data=dat_long)  
  frequentist_m=lmer(rate ~ ver_ind +(1|country3), data=dat_long)
  frequentist=broom.mixed::tidy(frequentist_m)
  }else if(i=="hor_ind"){
  datt=lmBF(rate ~   hor_ind + country3, data=dat_long, whichRandom="country3",rscaleCont = c("hor_ind" = 0.19))
  datt2=lmBF(rate ~  country3, whichRandom="country3",data=dat_long)  
  frequentist_m=lmer(rate ~ hor_ind +(1|country3), data=dat_long)
  frequentist=broom.mixed::tidy(frequentist_m)
  }else if(i=="ver_col"){
  datt=lmBF(rate ~   ver_col + country3, data=dat_long, whichRandom="country3",rscaleCont = c("ver_col" = 0.19))
  datt2=lmBF(rate ~  country3, whichRandom="country3",data=dat_long)  
  frequentist_m=lmer(rate ~ ver_col +(1|country3), data=dat_long)
  frequentist=broom.mixed::tidy(frequentist_m)
  }else if(i=="hor_col"){
  datt=lmBF(rate ~   hor_col + country3, data=dat_long, whichRandom="country3",rscaleCont = c("hor_col" = 0.19))
  datt2=lmBF(rate ~  country3, whichRandom="country3",data=dat_long)  
  frequentist_m=lmer(rate ~ hor_col +(1|country3), data=dat_long)
  frequentist=broom.mixed::tidy(frequentist_m)
  }
datt3=datt/datt2
datt3=as_tibble(recompute(datt3, iterations = 50000))
tabledata_s2a_ind[i, "BF"]=signif(datt3[1,1],4)
tabledata_s2a_ind[i, "b"]=round(frequentist[2, "estimate"],3)
tabledata_s2a_ind[i, "p"]=round(frequentist[2, "p.value"],3)
graphdata[i, "b"]=round(frequentist[2, "estimate"],3)
graphdata[i, "lower"]=round(confint(frequentist_m),2)[4,1]
graphdata[i, "higher"]=round(confint(frequentist_m),2)[4,2]

}

graphdata=graphdata[-1,]
rownames(tabledata_s2a_ind) <- NULL


kbl(
  tabledata_s2a_ind,
  format = "latex",
  booktabs = T,
  escape=T,
  caption = "Is the interaction of personal force and intention affected by individualism/collectivism on Trolley dilemmas?",
  centering=T,
  position="H"
  )%>%
  kable_styling( full_width = F,  position="left")%>%
  row_spec(row=0, bold=TRUE)

```


```{r study2a overall individualism plot w/o exc, fig.pos="H",out.width="80%",fig.cap="Correlation between country-level individualism/collectivism and moral accessibility ratings on the Trolley dilemmas (higher moral acceptibility means higher acceptibility of the utilitarian choice)", echo =FALSE,message=FALSE, warning=FALSE, paged.print=FALSE}
##cohen d calculation for every country
#scatterplot: x effect size, y individualism
#size of dots: cohen d
countrydata=data.frame(country=levels(factor(utilitarian_trolley$country3)), matrix(nrow=length(levels(factor(utilitarian_trolley$country3))),ncol=3, dimnames=list(levels(factor(utilitarian_trolley$country3)), c("cohend","Collectivism","N") )))

for (i in levels(factor(utilitarian_trolley$country3))){
  d=subset(utilitarian_trolley, country3==i, select=c("trolley_1_rate", "trolley_2_rate", "trolley_3_rate", "trolley_4_rate", "trolley_5_rate", "trolley_6_rate"))
  dat_long=na.omit(melt(data=d, variable.name = "condition", value.name="rate"))
  if (length(dat_long$rate)<10){
    countrydata[i,"cohend"]=NA
  }else{
    countrydata[i,"cohend"]=mean(dat_long$rate)
  }
  countrydata[i,"Collectivism"]=mean(utilitarian_trolley[utilitarian_trolley$country3==i,]$Collectivism, na.rm=T)
  countrydata[i,"N"]=length(dat_long$rate)
}

countrydata=na.omit(countrydata)
ggplot(countrydata, aes(x=cohend, y=Collectivism, label=country)) +
  geom_point(aes(size=N))+
  geom_text(hjust=-0.2,size=3)+
geom_smooth(method = "lm", mapping = aes(weight = N), color = "blue", show.legend = FALSE, se=F)+xlab("Average moral acceptibility rating")+
  theme_bw()+
  theme(panel.grid.major=element_blank(),panel.grid.minor=element_blank(),plot.title=element_text( hjust=0.5, vjust=0.5, face="bold", size=17),
        axis.title.x=element_text(face="bold", size=12, colour="Black"), axis.title.y=element_text(face="bold", size=12, colour="Black"), axis.text.x = element_text(face="bold", size=10, colour="Black"), axis.text.y = element_text(face="bold", size=12, colour="Black"),
        legend.title=element_text(face="bold", size=10, colour="Black"),legend.text=element_text(size=9))
  
  

```


<!-- Bayesian personal level individualism  w/o exclusion-->
```{r study2a vertical horizontal individualism w/o excl, out.width="80%", fig.cap="Personal level individualism/collectivism effects on moral acceptibility ratings (trolley dilemmas)", echo =FALSE,message=FALSE, warning=FALSE, paged.print=FALSE}


ggplot(graphdata, aes(x=variable, y=b, width=0.7)) +
 geom_bar(stat="identity", position="dodge", colour="Black",  width=1.2)+
  geom_errorbar(aes(ymin=lower, ymax=higher), position=position_dodge(width=0.7), colour="Black", width=0.2) +
  labs( y="Beta effect size")+ theme_bw()+
  geom_hline(yintercept=0)+
  theme(panel.grid.major=element_blank(),panel.grid.minor=element_blank(),plot.title=element_text( hjust=0.5, vjust=0.5, face="bold", size=17),
        axis.title.x=element_blank(), axis.title.y=element_text(face="bold", size=10), axis.text.x = element_text(face="bold", size=7, colour="Black"), axis.text.y = element_text(face="bold", size=12, colour="Black"),
        legend.title=element_blank(),legend.text=element_text(size=9))


```


<!-- Bayesian country level individualism w/o exclusion -->
```{r analysis individual + country level study 2b wo/excl, echo =FALSE,message=FALSE, warning=FALSE, paged.print=FALSE}

vars=c("Collectivism", "ver_ind", "hor_ind", "ver_col", "hor_col")
tabledata_s2b_ind = data.frame(variable=c("Country-level collectivism", "Vertical Individualism", "Horizontal Individualism", "Vertical Collectivism", "Horizontal Collectivism"), matrix(nrow=5, ncol=3, dimnames=list(vars,c("BF", "b",  "p"))))

dat=subset(utilitarian_speedboat,  select=c("speedboat_1_rate", "speedboat_2_rate", "speedboat_3_rate", "speedboat_4_rate", "speedboat_5_rate", "speedboat_6_rate", "country3", vars))
dat_long=na.omit(melt(data=dat, variable.name = "condition", value.name="rate", id.vars=c(vars, "country3")))
dat_long$country3=as.character(dat_long$country3)
dat_long$country3=factor(paste0("0", dat_long$country3))

graphdata=data.frame(variable=c("Country-level collectivism", "Vertical Individualism", "Horizontal Individualism", "Vertical Collectivism", "Horizontal Collectivism"), matrix(nrow=5, ncol=3, dimnames=list(vars,c("b",  "lower", "higher"))))

for (i in vars){
  if(i=="Collectivism"){
  datt=lmBF(rate ~   Collectivism + country3, data=dat_long, whichRandom="country3",rscaleCont = c("Collectivism" = 0.19))
  datt2=lmBF(rate ~  country3, whichRandom="country3",data=dat_long)  
  frequentist_m=lmer(rate ~ Collectivism +(1|country3), data=dat_long)
  frequentist=broom.mixed::tidy(frequentist_m)
  } else if(i=="ver_ind"){
  datt=lmBF(rate ~   ver_ind + country3, data=dat_long, whichRandom="country3",rscaleCont = c("ver_ind" = 0.19))
  datt2=lmBF(rate ~  country3, whichRandom="country3",data=dat_long)  
  frequentist_m=lmer(rate ~ ver_ind +(1|country3), data=dat_long)
  frequentist=broom.mixed::tidy(frequentist_m)
  }else if(i=="hor_ind"){
  datt=lmBF(rate ~   hor_ind + country3, data=dat_long, whichRandom="country3",rscaleCont = c("hor_ind" = 0.19))
  datt2=lmBF(rate ~  country3, whichRandom="country3",data=dat_long)  
  frequentist_m=lmer(rate ~ hor_ind +(1|country3), data=dat_long)
  frequentist=broom.mixed::tidy(frequentist_m)
  }else if(i=="ver_col"){
  datt=lmBF(rate ~   ver_col + country3, data=dat_long, whichRandom="country3",rscaleCont = c("ver_col" = 0.19))
  datt2=lmBF(rate ~  country3, whichRandom="country3",data=dat_long)  
  frequentist_m=lmer(rate ~ ver_col +(1|country3), data=dat_long)
  frequentist=broom.mixed::tidy(frequentist_m)
  }else if(i=="hor_col"){
  datt=lmBF(rate ~   hor_col + country3, data=dat_long, whichRandom="country3",rscaleCont = c("hor_col" = 0.19))
  datt2=lmBF(rate ~  country3, whichRandom="country3",data=dat_long)  
  frequentist_m=lmer(rate ~ hor_col +(1|country3), data=dat_long)
  frequentist=broom.mixed::tidy(frequentist_m)
  }
datt3=datt/datt2
datt3=as_tibble(recompute(datt3, iterations = 50000))
tabledata_s2b_ind[i, "BF"]=signif(datt3[1,1],4)
tabledata_s2b_ind[i, "b"]=round(frequentist[2, "estimate"],3)
tabledata_s2b_ind[i, "p"]=round(frequentist[2, "p.value"],3)
graphdata[i, "b"]=round(frequentist[2, "estimate"],3)
graphdata[i, "lower"]=round(confint(frequentist_m),2)[4,1]
graphdata[i, "higher"]=round(confint(frequentist_m),2)[4,2]

}

graphdata=graphdata[-1,]
rownames(tabledata_s2b_ind) <- NULL


kbl(
  tabledata_s2b_ind,
  format = "latex",
  booktabs = T,
  escape=T,
  caption = "Is the interaction of personal force and intention affected by individualism/collectivism on Trolley dilemmas?",
  centering=T,
  position="H"
  )%>%
  kable_styling( full_width = F,  position="left")%>%
  row_spec(row=0, bold=TRUE)

```


```{r study2b overall individualism plot w/o excl, fig.pos="H",out.width="80%",fig.cap="Correlation between country-level individualism/collectivism and moral accessibility ratings on the Speedboat dilemmas (higher moral acceptibility means higher acceptibility of the utilitarian choice)", echo =FALSE,message=FALSE, warning=FALSE, paged.print=FALSE}
##cohen d calculation for every country
#scatterplot: x effect size, y individualism
#size of dots: cohen d
countrydata=data.frame(country=levels(factor(utilitarian_speedboat$country3)), matrix(nrow=length(levels(factor(utilitarian_speedboat$country3))),ncol=3, dimnames=list(levels(factor(utilitarian_speedboat$country3)), c("cohend","Collectivism","N") )))

for (i in levels(factor(utilitarian_speedboat$country3))){
  d=subset(utilitarian_speedboat, country3==i, select=c("speedboat_1_rate", "speedboat_2_rate", "speedboat_3_rate", "speedboat_4_rate", "speedboat_5_rate", "speedboat_6_rate"))
  dat_long=na.omit(melt(data=d, variable.name = "condition", value.name="rate"))
  if (length(dat_long$rate)<10){
    countrydata[i,"cohend"]=NA
  }else{
    countrydata[i,"cohend"]=mean(dat_long$rate)
  }
  countrydata[i,"Collectivism"]=mean(utilitarian_speedboat[utilitarian_speedboat$country3==i,]$Collectivism, na.rm=T)
  countrydata[i,"N"]=length(dat_long$rate)
}

countrydata=na.omit(countrydata)
ggplot(countrydata, aes(x=cohend, y=Collectivism, label=country)) +
  geom_point(aes(size=N))+
  geom_text(hjust=-0.2,size=3)+
geom_smooth(method = "lm", mapping = aes(weight = N), color = "blue", show.legend = FALSE, se=F)+xlab("Average moral acceptibility rating")+
  theme_bw()+
  theme(panel.grid.major=element_blank(),panel.grid.minor=element_blank(),plot.title=element_text( hjust=0.5, vjust=0.5, face="bold", size=17),
        axis.title.x=element_text(face="bold", size=12, colour="Black"), axis.title.y=element_text(face="bold", size=12, colour="Black"), axis.text.x = element_text(face="bold", size=10, colour="Black"), axis.text.y = element_text(face="bold", size=12, colour="Black"),
        legend.title=element_text(face="bold", size=10, colour="Black"),legend.text=element_text(size=9))
  


```


<!-- Bayesian personal level individualism  w/o exclusion-->
```{r study2b vertical horizontal individualism w/o excl,  out.width="80%", fig.cap="Personal level individualism/collectivism effects on moral acceptibility ratings (speedboat dilemmas)", echo =FALSE,message=FALSE, warning=FALSE, paged.print=FALSE}


ggplot(graphdata, aes(x=variable, y=b, width=0.7)) +
 geom_bar(stat="identity", position="dodge", colour="Black",  width=1.2)+
  geom_errorbar(aes(ymin=lower, ymax=higher), position=position_dodge(width=0.7), colour="Black", width=0.2) +
  labs( y="Beta effect size")+ theme_bw()+
  geom_hline(yintercept=0)+
  theme(panel.grid.major=element_blank(),panel.grid.minor=element_blank(),plot.title=element_text( hjust=0.5, vjust=0.5, face="bold", size=17),
        axis.title.x=element_blank(), axis.title.y=element_text(face="bold", size=10), axis.text.x = element_text(face="bold", size=7, colour="Black"), axis.text.y = element_text(face="bold", size=12, colour="Black"),
        legend.title=element_blank(),legend.text=element_text(size=9))



```

